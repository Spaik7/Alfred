#!/usr/bin/env python3
"""
Fixed Mycroft Precise Listener
Loads model with custom loss function registered
"""

import pyaudio
import numpy as np
from keras.models import load_model
import keras.backend as K
import argparse
from pathlib import Path

try:
    import sonopy
    HAS_SONOPY = True
except ImportError:
    HAS_SONOPY = False
    print("⚠️  Warning: sonopy not found, using simplified features")


def weighted_log_loss(y_true, y_pred):
    """Custom loss function used by Mycroft Precise"""
    false_pos = y_pred * (1.0 - y_true)
    false_neg = (1.0 - y_pred) * y_true
    return K.mean(false_pos + false_neg * 5.0)


class SimplePreciseListener:
    def __init__(self, model_path, chunk_size=2048, sample_rate=16000, recording_rate=48000):
        self.chunk_size = chunk_size
        self.sample_rate = sample_rate  # Target rate for model
        self.recording_rate = recording_rate  # Actual mic rate
        
        # Load model with custom objects
        print(f"Loading model: {model_path}")
        self.model = load_model(
            model_path, 
            custom_objects={'weighted_log_loss': weighted_log_loss},
            compile=False
        )
        print("✓ Model loaded successfully!")
        print(f"ℹ️  Recording at {recording_rate}Hz, processing at {sample_rate}Hz")
        
        self.audio = pyaudio.PyAudio()
        self.buffer = []
        self.buffer_size = 